"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.build = void 0;
const promises_1 = __importDefault(require("fs/promises"));
const globby_1 = __importDefault(require("globby"));
const js_yaml_1 = __importDefault(require("js-yaml"));
const tsconfig_utils_1 = require("tsconfig-utils");
const path_1 = require("path");
async function build(cwd, args = []) {
    var _a;
    const config = await (0, tsconfig_utils_1.load)(cwd, args);
    const outDir = config.get('outDir');
    const rootDir = config.get('rootDir');
    const noEmit = config.get('noEmit');
    const emitDeclarationOnly = config.get('emitDeclarationOnly');
    if (!outDir || !rootDir || noEmit || emitDeclarationOnly)
        return;
    const loaders = ((_a = config.atsc) === null || _a === void 0 ? void 0 : _a.loaders) || ['.yaml', '.yml'];
    const files = await (0, globby_1.default)(['**'], {
        cwd: (0, path_1.resolve)(cwd, rootDir),
        onlyFiles: true,
    });
    await Promise.all(files.map(async (file) => {
        const ext = (0, path_1.extname)(file);
        if (['.ts', '.mts', '.cts', '.tsx'].includes(ext))
            return;
        const src = (0, path_1.resolve)(cwd, rootDir, file);
        const dest = (0, path_1.resolve)(cwd, outDir, file);
        await promises_1.default.mkdir((0, path_1.dirname)(dest), { recursive: true });
        if (!loaders.includes(ext)) {
            await promises_1.default.copyFile(src, dest);
        }
        else if (['.yaml', '.yml'].includes(ext)) {
            const data = js_yaml_1.default.load(await promises_1.default.readFile(src, 'utf8'));
            await promises_1.default.writeFile(dest.slice(0, -ext.length) + '.json', JSON.stringify(data) || '');
        }
    }));
}
exports.build = build;
