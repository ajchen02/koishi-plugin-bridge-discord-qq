"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const _1 = require(".");
const kleur_1 = require("kleur");
const yargs_parser_1 = __importDefault(require("yargs-parser"));
require("./plugins/prepare");
if (process.argv.length <= 2) {
    console.log('yakumo');
    process.exit(0);
}
const name = process.argv[2];
for (const filename of _1.config.require) {
    (0, _1.configRequire)(filename);
}
for (const name in _1.config.pipeline) {
    (0, _1.register)(name, async () => {
        const tasks = _1.config.pipeline[name];
        for (const task of tasks) {
            const [name, ...args] = task.split(/\s+/g);
            await execute(name, ...args);
        }
    });
}
const project = new _1.Project();
async function execute(name, ...args) {
    (0, _1.requireSafe)('yakumo-' + name);
    if (!_1.commands[name]) {
        console.error((0, kleur_1.red)(`unknown command: ${name}`));
        process.exit(1);
    }
    const [callback, options] = _1.commands[name];
    const argv = (0, yargs_parser_1.default)([...process.argv.slice(3), ...args], options);
    argv.config = options;
    await project.initialize(argv);
    return callback(project);
}
execute(name);
