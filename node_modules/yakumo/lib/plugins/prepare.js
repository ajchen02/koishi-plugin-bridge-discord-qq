"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const __1 = require("..");
const picomatch_1 = __importDefault(require("picomatch"));
(0, __1.register)('prepare', async (project) => {
    const { workspaces } = project.workspaces[''];
    const current = new Set(workspaces);
    if (!current.size)
        return;
    const match = (0, picomatch_1.default)(workspaces);
    let hasUpdate = false;
    for (const prefix in project.workspaces) {
        if (!prefix)
            continue;
        const { workspaces = [] } = project.workspaces[prefix];
        for (const path of workspaces) {
            const result = prefix.slice(1) + '/' + path;
            if (match(result))
                continue;
            console.log(`[I] workspace added: ${result}`);
            current.add(result);
            hasUpdate = true;
        }
        for (const path of current) {
            if (!path.startsWith(prefix.slice(1) + '/'))
                continue;
            if (workspaces.includes(path.slice(prefix.length)))
                continue;
            if (project.argv.clean) {
                console.log(`[W] workspace removed: ${path}`);
                current.delete(path);
                hasUpdate = true;
            }
            else {
                console.log(`[W] workspace mismatch: ${path}`);
            }
        }
    }
    if (hasUpdate) {
        project.workspaces[''].workspaces = [...current].sort();
        await project.save('');
        await (0, __1.install)();
    }
}, {
    manual: true,
    alias: {
        clean: ['c'],
    },
});
